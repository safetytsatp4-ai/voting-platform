// ======================================
// Admin System - Logic (Thai Summit Automotive)
// ======================================

// ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡∏Ç‡∏≠‡∏á admin.js ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô db ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤
const db = window.db || (typeof firebase !== 'undefined' ? firebase.database() : null);

if (!db) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏î‡πâ! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå firebase-config.js");
}
const ADMIN_PASSWORD = "123456789";

// 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
function checkAdminPass() {
    const pass = document.getElementById('adminPass').value;
    if (pass === ADMIN_PASSWORD) {
        document.getElementById('adminLogin').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        
        listenToResults(); 
        loadPollHistory(); // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå
        console.log("üîì Admin logged in & Listening to votes...");
    } else {
        alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
    }
}

// 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏´‡∏ß‡∏ï (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢)
function updatePoll() {
    const question = document.getElementById('newQuestion').value;
    const desc = document.getElementById('newDesc').value;

    if (!question) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÇ‡∏´‡∏ß‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö");
        return;
    }

    const pollData = {
        question: question,
        description: desc,
        status: 'active',
        timestamp: Date.now()
    };

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà poll001
    db.ref('polls/poll001').set(pollData)
    .then(() => {
        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á pollHistory ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
        db.ref('pollHistory').push(pollData); 
        
        alert("üì¢ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
        document.getElementById('newQuestion').value = "";
        document.getElementById('newDesc').value = "";
    })
    .catch((error) => alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message));
}

// 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å pollHistory)
function loadPollHistory() {
    // ‡πÉ‡∏ä‡πâ id ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÉ‡∏ô html (historyTableBody ‡∏´‡∏£‡∏∑‡∏≠ pollHistory)
    const historyTableBody = document.getElementById('historyTableBody');
    
    db.ref('pollHistory').on('value', (snapshot) => {
        const historyData = snapshot.val() || {};
        const polls = Object.values(historyData).reverse(); // ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤
        
        if (polls.length === 0) {
            historyTableBody.innerHTML = '<tr><td colspan="2" style="text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</td></tr>';
            return;
        }

        let html = '';
        polls.forEach(poll => {
            const date = new Date(poll.timestamp).toLocaleString('th-TH');
            html += `
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;">${date}</td>
                    <td style="padding: 10px; border: 1px solid #ddd;">${poll.question}</td>
                </tr>
            `;
        });
        historyTableBody.innerHTML = html;
    });
}

// 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï Real-time
function listenToResults() {
    db.ref('votes/poll001').on('value', (snapshot) => {
        const votes = snapshot.val() || {};
        const voteEntries = Object.values(votes);
        
        const counts = { approve: 0, disapprove: 0, abstain: 0 };
        voteEntries.forEach(vote => {
            if (counts.hasOwnProperty(vote.option)) counts[vote.option]++;
        });

        const total = voteEntries.length;
        updateAdminUI(counts, total);
    });
}

// 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
function updateAdminUI(counts, total) {
    document.getElementById('approveCount').textContent = counts.approve;
    document.getElementById('disapproveCount').textContent = counts.disapprove;
    document.getElementById('abstainCount').textContent = counts.abstain;
    document.getElementById('totalVotes').textContent = total;

    ['approve', 'disapprove', 'abstain'].forEach(opt => {
        const percent = total > 0 ? Math.round((counts[opt] / total) * 100) : 0;
        const bar = document.getElementById(opt + 'Bar');
        if (bar) {
            bar.style.width = percent + '%';
            bar.textContent = percent + '%';
        }
    });
}

// 6. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï / ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô / Export
function closePoll() {
    db.ref('polls/poll001').update({ status: 'closed' }).then(() => alert("üõë ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß"));
}

function clearVotes() {
    if (confirm("‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
        db.ref('votes/poll001').remove().then(() => alert("üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"));
    }
}

function exportToExcel() {
    db.ref('polls/poll001').once('value', (pollSnap) => {
        const currentQuestion = pollSnap.val() ? pollSnap.val().question : "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠";
        db.ref('votes/poll001').once('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const rows = Object.values(data).map(item => ({
                "‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠": currentQuestion,
                "‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô": item.employeeId,
                "‡∏°‡∏ï‡∏¥": item.option === 'approve' ? '‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö' : item.option === 'disapprove' ? '‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏≠‡∏ö' : '‡∏á‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á',
                "‡πÄ‡∏ß‡∏•‡∏≤": new Date(item.timestamp).toLocaleString('th-TH')
            }));
            const worksheet = XLSX.utils.json_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Results");
            XLSX.writeFile(workbook, `Report_${Date.now()}.xlsx`);
        });
    });
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
function clearHistory() {
    if (confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠' ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? \n(‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ)")) {
        db.ref('pollHistory').remove()
        .then(() => {
            alert("üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            // ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            document.getElementById('historyTableBody').innerHTML = '<tr><td colspan="2" style="text-align:center;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</td></tr>';
        })
        .catch((error) => alert("‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message));
    }
}